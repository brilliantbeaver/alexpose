name: Quality Gates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC to track trends
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: 80
  FAIL_ON_THRESHOLD: true
  FAIL_ON_QUALITY_GATE: true

jobs:
  quality-gates:
    name: Quality Gates Enforcement
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for trend analysis
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"
          pip install pytest-json-report codecov
      
      - name: Run coverage analysis
        id: coverage
        run: |
          chmod +x scripts/ci-coverage-reporter.sh
          bash scripts/ci-coverage-reporter.sh
        env:
          COVERAGE_THRESHOLD: ${{ env.COVERAGE_THRESHOLD }}
          FAIL_ON_THRESHOLD: ${{ env.FAIL_ON_THRESHOLD }}
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
          GENERATE_REPORTS: true
          CAPTURE_TRENDS: true
        continue-on-error: true
      
      - name: Run quality gates
        id: quality_gates
        run: |
          chmod +x scripts/ci-quality-gates.sh
          bash scripts/ci-quality-gates.sh
        env:
          FAIL_ON_QUALITY_GATE: ${{ env.FAIL_ON_QUALITY_GATE }}
          RUN_MUTATION_TESTING: false  # Disabled by default (slow)
          GENERATE_QUALITY_REPORT: true
          TRACK_QUALITY_METRICS: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Upload coverage reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage.xml
            coverage.json
            htmlcov/
            coverage_gap_report.md
            coverage_trend_report.md
            coverage_summary.md
          retention-days: 30
      
      - name: Upload quality reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: quality-reports
          path: |
            quality_report.json
            quality_metrics_report.md
            quality_gates_summary.md
            quality_gates_output.txt
          retention-days: 30
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Comment PR with results
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request' && always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let comment = '## Quality Gates Report\n\n';
            
            // Add coverage summary
            if (fs.existsSync('coverage_summary.md')) {
              const coverageSummary = fs.readFileSync('coverage_summary.md', 'utf8');
              comment += coverageSummary + '\n\n';
            }
            
            // Add quality gates summary
            if (fs.existsSync('quality_gates_summary.md')) {
              const qualitySummary = fs.readFileSync('quality_gates_summary.md', 'utf8');
              comment += qualitySummary + '\n\n';
            }
            
            // Add footer
            comment += '---\n';
            comment += `*Generated by [Quality Gates Workflow](${context.payload.repository.html_url}/actions/runs/${context.runId})*`;
            
            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Check quality gates status
        if: always()
        run: |
          if [ "${{ steps.coverage.outcome }}" != "success" ] || [ "${{ steps.quality_gates.outcome }}" != "success" ]; then
            echo "Quality gates failed!"
            exit 1
          fi
          echo "All quality gates passed!"

  mutation-testing:
    name: Mutation Testing (Weekly)
    runs-on: ubuntu-latest
    # Only run on schedule or manual trigger
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"
      
      - name: Run mutation testing
        run: |
          python -m tests.quality.mutation_testing \
            --max-mutations 20 \
            --report mutation_testing_report.md
        continue-on-error: true
      
      - name: Upload mutation testing report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: mutation-testing-report
          path: mutation_testing_report.md
          retention-days: 90

  coverage-trends:
    name: Coverage Trend Analysis
    runs-on: ubuntu-latest
    # Only run on main branch
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"
          pip install matplotlib
      
      - name: Restore coverage trends database
        uses: actions/cache@v3
        with:
          path: coverage_trends.db
          key: coverage-trends-${{ github.ref }}
          restore-keys: |
            coverage-trends-
      
      - name: Capture coverage snapshot
        run: |
          python -m tests.coverage.coverage_trend_analyzer --capture
      
      - name: Generate trend report
        run: |
          python -m tests.coverage.coverage_trend_analyzer \
            --report coverage_trend_report.md \
            --chart coverage_trends.png \
            --days 90
      
      - name: Upload trend reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-trends
          path: |
            coverage_trend_report.md
            coverage_trends.png
          retention-days: 90
      
      - name: Save coverage trends database
        uses: actions/cache@v3
        if: always()
        with:
          path: coverage_trends.db
          key: coverage-trends-${{ github.ref }}-${{ github.run_number }}

  quality-metrics:
    name: Quality Metrics Tracking
    runs-on: ubuntu-latest
    # Only run on main branch
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"
          pip install pytest-json-report
      
      - name: Restore quality metrics database
        uses: actions/cache@v3
        with:
          path: test_quality_metrics.db
          key: quality-metrics-${{ github.ref }}
          restore-keys: |
            quality-metrics-
      
      - name: Collect quality metrics
        run: |
          python -m tests.quality.test_quality_metrics --collect
      
      - name: Generate quality report
        run: |
          python -m tests.quality.test_quality_metrics \
            --report quality_metrics_report.md \
            --trends 30
      
      - name: Upload quality metrics report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: quality-metrics
          path: quality_metrics_report.md
          retention-days: 90
      
      - name: Save quality metrics database
        uses: actions/cache@v3
        if: always()
        with:
          path: test_quality_metrics.db
          key: quality-metrics-${{ github.ref }}-${{ github.run_number }}
